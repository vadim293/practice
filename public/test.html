<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Создание объявления</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .suggestions-container {
            position: relative;
        }
        .suggestions-list {
            position: absolute;
            z-index: 1000;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: none;
        }
        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .suggestion-item:hover {
            background-color: #f8f9fa;
        }
        .form-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        .suggestions-list {
    position: absolute;
    z-index: 1000;
    width: 100%;
    max-height: 300px;
    overflow-y: auto;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 4px 4px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    display: none;
}

.suggestion-item {
    padding: 8px 12px;
    cursor: pointer;
    transition: background 0.2s;
}

.suggestion-item:hover {
    background-color: #f8f9fa;
}

.text-muted {
    color: #6c757d;
    font-style: italic;
}

.text-danger {
    color: #dc3545;
}

.suggestions-container {
    position: relative;
}

#suggestions-loader {
    padding: 8px 12px;
    display: flex;
    align-items: center;
}
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="form-container">
            <h1 class="text-center mb-4">Создать новое объявление</h1>
            
            <form id="announcementForm" action="/adderAnnoumcement" method="POST" enctype="multipart/form-data">
                <!-- Основные поля -->
                <div class="row mb-3">
                    <div class="col-md-6 mb-3">
                        <label for="title" class="form-label">Название объявления*</label>
                        <input type="text" id="title" name="title" class="form-control" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="price" class="form-label">Цена (руб)*</label>
                        <input type="number" id="price" name="price" class="form-control" required>
                    </div>
                </div>

                <!-- Поле с автодополнением адреса -->
                <div class="mb-3 suggestions-container">
                    <label for="address" class="form-label">Адрес*</label>
                    <input type="text" id="address" name="address" class="form-control" 
                           autocomplete="off" required placeholder="Начните вводить адрес (Омск)">
                    <div id="suggestions" class="suggestions-list">
                        <div id="suggestions-loader" style="display: none;">
                            <div class="spinner-border spinner-border-sm me-2"></div>
                            <span>Идёт поиск...</span>
                        </div>
                        <div id="suggestions-results"></div>
                    </div>
                    <input type="hidden" id="latitude" name="latitude">
                    <input type="hidden" id="longitude" name="longitude">
                </div>

                <!-- Описание -->
                <div class="mb-3">
                    <label for="description" class="form-label">Описание*</label>
                    <textarea id="description" name="description" class="form-control" rows="4" required></textarea>
                </div>

                <!-- Характеристики -->
                <div class="row mb-3">
                    <div class="col-md-4 mb-3">
                        <label for="type" class="form-label">Тип недвижимости*</label>
                        <select id="type" name="type" class="form-select" required>
                            <option value="">Выберите тип</option>
                            <option value="apartment">Квартира</option>
                            <option value="house">Дом</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="rooms" class="form-label">Количество комнат*</label>
                        <input type="number" id="rooms" name="rooms" class="form-control" min="1" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="area" class="form-label">Площадь (м²)*</label>
                        <input type="number" id="area" name="area" class="form-control" step="0.1" min="1" required>
                    </div>
                </div>

                <!-- Загрузка фотографий -->
                <div class="mb-4">
                    <label for="photos" class="form-label">Фотографии</label>
                    <input type="file" id="photos" name="file_name[]" class="form-control" multiple accept="image/*">
                    <div class="form-text">Можно загрузить несколько фотографий (максимум 10)</div>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg">Опубликовать объявление</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            // Конфигурация
            const config = {
                minQueryLength: 2,
                debounceDelay: 300,
                maxResults: 5
            };
        
            // Элементы
            const $address = $('#address');
            const $suggestions = $('#suggestions');
            const $loader = $('#suggestions-loader');
            const $results = $('#suggestions-results');
            const $latitude = $('#latitude');
            const $longitude = $('#longitude');
        
            // Обработчик ввода
            $address.on('input', debounce(function() {
                const query = $(this).val().trim();
                
                if (query.length < config.minQueryLength) {
                    hideSuggestions();
                    return;
                }
        
                fetchSuggestions(query);
            }, config.debounceDelay));
        
            // Запрос к серверу
            function fetchSuggestions(query) {
                showLoader();
                
                $.ajax({
                    url: '/geocoder',
                    method: 'GET',
                    data: {
                        geocode: query,
                        format: 'json',
                        limit: config.maxResults
                    },
                    success: function(serverResponse) {
                        
                        try {
                            // Преобразуем ответ сервера в массив адресов
                            const response = extractAddresses(serverResponse);
                            
                            if (response && response.length > 0) {
                                showSuggestions(response);
                            } else {
                                showNoResults();
                            }
                        } catch (error) {
                            console.error('Ошибка обработки ответа:', error);
                            showNoResults();
                        }
                    },
                    error: function(xhr) {
                        console.error('Ошибка запроса:', xhr);
                        showError(xhr.status);
                    }
                });
            }

            // Функция для извлечения адресов из различных форматов ответа
            function extractAddresses(serverResponse) {
                // Логируем полный ответ для отладки
                console.log('Полный ответ геокодера:', serverResponse);
                
                // Если ответ уже содержит массив адресов
                if (Array.isArray(serverResponse)) {
                    return serverResponse.map(item => ({
                        address: item.address || item.name || 'Неизвестный адрес',
                        coordinates: item.coordinates || getCoordinatesFromItem(item)
                    }));
                }
                
                // Обработка структуры Яндекс.Карт
                if (serverResponse.response?.GeoObjectCollection?.featureMember) {
                    return serverResponse.response.GeoObjectCollection.featureMember.map(feature => {
                        const geoObject = feature.GeoObject || {};
                        return {
                            address: geoObject.metaDataProperty?.GeocoderMetaData?.text || 
                                geoObject.name || 
                                'Адрес не указан',
                            coordinates: getCoordinatesFromItem(geoObject)
                        };
                    });
                }
                
                // Обработка других популярных форматов
                if (serverResponse.data) {
                    return serverResponse.data.map(item => ({
                        address: item.address || item.properties?.name || item.formatted_address || 'Адрес не указан',
                        coordinates: item.coordinates || getCoordinatesFromItem(item)
                    }));
                }
                
                console.warn('Неизвестный формат ответа:', serverResponse);
                return [];
            }

            // Вспомогательная функция для извлечения координат из разных структур
            function getCoordinatesFromItem(item) {
                
                // Яндекс.Карты
                if (item.Point?.pos) {
                    const [lon, lat] = item.Point.pos.split(' ');
                    return { lat: parseFloat(lat), lon: parseFloat(lon) };
                }
                
                // GeoJSON (longitude, latitude)
                if (item.geometry?.coordinates?.length >= 2) {
                    return { 
                        lon: parseFloat(item.geometry.coordinates[0]),
                        lat: parseFloat(item.geometry.coordinates[1])
                    };
                }
                
                // Прямые поля
                if (item.lat && item.lon) {
                    return { lat: parseFloat(item.lat), lon: parseFloat(item.lon) };
                }
                if (item.latitude && item.longitude) {
                    return { lat: parseFloat(item.latitude), lon: parseFloat(item.longitude) };
                }
                
                return null;
            }

            // Модифицированная функция showSuggestions
            function showSuggestions(addressObjects) {
                $results.empty();
                
                addressObjects.forEach(item => {
                    const $suggestionItem = $('<div>')
                        .addClass('suggestion-item')
                        .text(item.address)
                        .click(function() {
                            // Проверяем наличие координат перед выбором
                            if (!item.coordinates || !item.coordinates.lat || !item.coordinates.lon) {
                                console.warn('Координаты не найдены для адреса:', item.address);
                                // Можно добавить fallback-запрос для геокодирования
                                fetchCoordinatesFallback(item.address);
                                return;
                            }
                            selectSuggestion(item);
                        })
                        .appendTo($results);
                    
                    // Добавляем скрытые данные с координатами в элемент
                    $suggestionItem.data('coordinates', item.coordinates);
                });
                
                $loader.hide();
                $results.show();
                $suggestions.show();
            }
                    
            // Выбор подсказки
            function selectSuggestion(suggestion) {
                $address.val(suggestion.address)
                    .data('selected', true);
                $latitude.val(suggestion.coordinates?.lat || '');         
                $longitude.val(suggestion.coordinates?.lon || '');
                hideSuggestions();
            }
        
            // Вспомогательные функции
            function showLoader() {
                $results.hide();
                $loader.show();
                $suggestions.show();
            }
        
            function showNoResults() {
                $results.html('<div class="suggestion-item text-muted">Ничего не найдено</div>');
                $loader.hide();
                $results.show();
                $suggestions.show();
            }
        
            function showError(status) {
                const message = status === 422 ? 'Некорректный запрос' : 
                                status === 500 ? 'Ошибка сервера' : 'Ошибка соединения';
                
                $results.html(`<div class="suggestion-item text-danger">${message}</div>`);
                $loader.hide();
                $results.show();
                $suggestions.show();
            }
        
            function hideSuggestions() {
                $suggestions.hide();
            }
        
            // Дебаунс
            function debounce(func, wait) {
                let timeout;
                return function() {
                    const context = this, args = arguments;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), wait);
                };
            }
        
            // Закрытие подсказок при клике вне поля
            $(document).click(function(e) {
                if (!$(e.target).closest('.suggestions-container').length) {
                    hideSuggestions();
                }
            });
        
            // Очистка координат при ручном изменении
            $address.on('change', function() {
                if (!$(this).data('selected')) {
                    $latitude.val('');
                    $longitude.val('');
                }
                
                $(this).removeData('selected');
            });
        });
        </script>
</body>
</html>